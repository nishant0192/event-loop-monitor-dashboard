<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Event Loop Monitor Dashboard</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #333;
      padding: 20px;
      min-height: 100vh;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    header {
      text-align: center;
      color: white;
      margin-bottom: 30px;
    }

    header h1 {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    }

    header p {
      font-size: 1.1rem;
      opacity: 0.9;
    }

    .health-banner {
      background: white;
      border-radius: 12px;
      padding: 20px 30px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: all 0.3s ease;
    }

    .health-banner.healthy {
      border-left: 5px solid #10b981;
    }

    .health-banner.degraded {
      border-left: 5px solid #f59e0b;
    }

    .health-banner.critical {
      border-left: 5px solid #ef4444;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
      50% { box-shadow: 0 4px 20px rgba(239, 68, 68, 0.4); }
    }

    .health-status {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .status-icon {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }

    .status-icon.healthy { background: #10b981; }
    .status-icon.degraded { background: #f59e0b; }
    .status-icon.critical { background: #ef4444; }

    .status-text h2 {
      font-size: 1.5rem;
      margin-bottom: 5px;
      text-transform: uppercase;
    }

    .status-text p {
      color: #666;
      font-size: 0.95rem;
    }

    .health-score {
      text-align: right;
    }

    .health-score .score {
      font-size: 3rem;
      font-weight: 700;
      line-height: 1;
      margin-bottom: 5px;
    }

    .health-score .label {
      color: #666;
      font-size: 0.9rem;
    }

    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .metric-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      transition: transform 0.2s ease;
    }

    .metric-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 12px rgba(0,0,0,0.15);
    }

    .metric-card h3 {
      font-size: 0.9rem;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 10px;
    }

    .metric-value {
      font-size: 2.5rem;
      font-weight: 700;
      color: #333;
      margin-bottom: 5px;
    }

    .metric-unit {
      font-size: 1rem;
      color: #666;
    }

    .metric-details {
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid #e5e7eb;
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      font-size: 0.85rem;
    }

    .detail-item {
      display: flex;
      justify-content: space-between;
    }

    .detail-label {
      color: #666;
    }

    .detail-value {
      font-weight: 600;
      color: #333;
    }

    .charts-section {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .chart-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .chart-card h3 {
      font-size: 1.1rem;
      color: #333;
      margin-bottom: 15px;
    }

    .chart-container {
      position: relative;
      height: 200px;
    }

    canvas {
      width: 100%;
      height: 100%;
    }

    .error-message {
      background: #fee;
      color: #c33;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      text-align: center;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: white;
      font-size: 1.2rem;
    }

    .timestamp {
      text-align: center;
      color: white;
      opacity: 0.8;
      font-size: 0.9rem;
      margin-top: 20px;
    }

    footer {
      text-align: center;
      color: white;
      opacity: 0.7;
      margin-top: 30px;
      font-size: 0.9rem;
    }

    @media (max-width: 768px) {
      header h1 {
        font-size: 1.8rem;
      }

      .health-banner {
        flex-direction: column;
        text-align: center;
        gap: 15px;
      }

      .health-score {
        text-align: center;
      }

      .charts-section {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>⚡ Event Loop Monitor</h1>
      <p>Real-time Node.js event loop health monitoring</p>
    </header>

    <div id="error" class="error-message" style="display: none;"></div>
    <div id="loading" class="loading">Loading metrics...</div>

    <div id="content" style="display: none;">
      <!-- Health Banner -->
      <div id="health-banner" class="health-banner">
        <div class="health-status">
          <div id="status-icon" class="status-icon">✓</div>
          <div class="status-text">
            <h2 id="status-text">HEALTHY</h2>
            <p id="status-message">Event loop is operating normally</p>
          </div>
        </div>
        <div class="health-score">
          <div id="health-score" class="score">100</div>
          <div class="label">Health Score</div>
        </div>
      </div>

      <!-- Metrics Grid -->
      <div class="metrics-grid">
        <!-- Event Loop Lag -->
        <div class="metric-card">
          <h3>Event Loop Lag</h3>
          <div>
            <span id="lag-mean" class="metric-value">0.0</span>
            <span class="metric-unit">ms</span>
          </div>
          <div class="metric-details">
            <div class="detail-item">
              <span class="detail-label">P50:</span>
              <span id="lag-p50" class="detail-value">0.0 ms</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">P95:</span>
              <span id="lag-p95" class="detail-value">0.0 ms</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">P99:</span>
              <span id="lag-p99" class="detail-value">0.0 ms</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Max:</span>
              <span id="lag-max" class="detail-value">0.0 ms</span>
            </div>
          </div>
        </div>

        <!-- Event Loop Utilization -->
        <div class="metric-card">
          <h3>Event Loop Utilization</h3>
          <div>
            <span id="elu-utilization" class="metric-value">0.0</span>
            <span class="metric-unit">%</span>
          </div>
          <div class="metric-details">
            <div class="detail-item">
              <span class="detail-label">Active:</span>
              <span id="elu-active" class="detail-value">0.0 ms</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Idle:</span>
              <span id="elu-idle" class="detail-value">0.0 ms</span>
            </div>
          </div>
        </div>

        <!-- Request Metrics -->
        <div class="metric-card">
          <h3>Request Metrics</h3>
          <div>
            <span id="req-count" class="metric-value">0</span>
            <span class="metric-unit">requests</span>
          </div>
          <div class="metric-details">
            <div class="detail-item">
              <span class="detail-label">Avg Time:</span>
              <span id="req-avg" class="detail-value">0.0 ms</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Charts -->
      <div class="charts-section">
        <div class="chart-card">
          <h3>Event Loop Lag (last 60s)</h3>
          <div class="chart-container">
            <canvas id="lag-chart"></canvas>
          </div>
        </div>

        <div class="chart-card">
          <h3>Event Loop Utilization (last 60s)</h3>
          <div class="chart-container">
            <canvas id="elu-chart"></canvas>
          </div>
        </div>
      </div>

      <div class="timestamp">
        Last updated: <span id="timestamp">-</span>
      </div>
    </div>

    <footer>
      <p>Event Loop Monitor Dashboard v1.0</p>
    </footer>
  </div>

  <script>
    // Configuration
    const REFRESH_INTERVAL = 1000; // 1 second
    const MAX_DATA_POINTS = 60;

    // State
    let lagHistory = [];
    let eluHistory = [];

    // DOM Elements
    const elements = {
      error: document.getElementById('error'),
      loading: document.getElementById('loading'),
      content: document.getElementById('content'),
      healthBanner: document.getElementById('health-banner'),
      statusIcon: document.getElementById('status-icon'),
      statusText: document.getElementById('status-text'),
      statusMessage: document.getElementById('status-message'),
      healthScore: document.getElementById('health-score'),
      timestamp: document.getElementById('timestamp')
    };

    // Initialize
    fetchDashboardData();
    setInterval(fetchDashboardData, REFRESH_INTERVAL);

    // Fetch dashboard data
    async function fetchDashboardData() {
      try {
        const response = await fetch('api/dashboard');
        const result = await response.json();

        if (result.status === 'ok') {
          elements.loading.style.display = 'none';
          elements.content.style.display = 'block';
          elements.error.style.display = 'none';

          updateDashboard(result.data);
        } else {
          showError(result.message || 'Failed to fetch metrics');
        }
      } catch (error) {
        showError('Connection error: ' + error.message);
      }
    }

    // Update dashboard with new data
    function updateDashboard(data) {
      // Update health banner
      updateHealthBanner(data.health);

      // Update metrics
      updateMetrics(data.current);

      // Update charts
      updateCharts(data.timeSeries);

      // Update timestamp
      elements.timestamp.textContent = new Date().toLocaleTimeString();
    }

    // Update health banner
    function updateHealthBanner(health) {
      const status = health.status;
      const score = health.score;
      const message = health.message;

      // Update banner style
      elements.healthBanner.className = `health-banner ${status}`;

      // Update icon
      elements.statusIcon.className = `status-icon ${status}`;
      elements.statusIcon.textContent = status === 'healthy' ? '✓' : 
                                        status === 'degraded' ? '⚠' : '✗';

      // Update text
      elements.statusText.textContent = status.toUpperCase();
      elements.statusMessage.textContent = message;

      // Update score
      elements.healthScore.textContent = score;
    }

    // Update metrics
    function updateMetrics(current) {
      // Lag metrics
      document.getElementById('lag-mean').textContent = current.lag.mean.toFixed(2);
      document.getElementById('lag-p50').textContent = current.lag.p50.toFixed(2) + ' ms';
      document.getElementById('lag-p95').textContent = current.lag.p95.toFixed(2) + ' ms';
      document.getElementById('lag-p99').textContent = current.lag.p99.toFixed(2) + ' ms';
      document.getElementById('lag-max').textContent = current.lag.max.toFixed(2) + ' ms';

      // ELU metrics
      document.getElementById('elu-utilization').textContent = current.elu.utilization.toFixed(1);
      document.getElementById('elu-active').textContent = current.elu.active.toFixed(2) + ' ms';
      document.getElementById('elu-idle').textContent = current.elu.idle.toFixed(2) + ' ms';

      // Request metrics
      document.getElementById('req-count').textContent = current.requests.count;
      document.getElementById('req-avg').textContent = current.requests.avgTime.toFixed(2) + ' ms';
    }

    // Update charts
    function updateCharts(timeSeries) {
      lagHistory = timeSeries.lag.slice(-MAX_DATA_POINTS);
      eluHistory = timeSeries.elu.slice(-MAX_DATA_POINTS);

      drawLagChart();
      drawEluChart();
    }

    // Draw lag chart
    function drawLagChart() {
      const canvas = document.getElementById('lag-chart');
      const ctx = canvas.getContext('2d');
      
      // Set canvas size
      canvas.width = canvas.offsetWidth;
      canvas.height = canvas.offsetHeight;

      const width = canvas.width;
      const height = canvas.height;
      const padding = 30;

      // Clear canvas
      ctx.clearRect(0, 0, width, height);

      if (lagHistory.length === 0) return;

      // Find min/max for scaling
      const meanValues = lagHistory.map(d => d.mean);
      const p95Values = lagHistory.map(d => d.p95);
      const allValues = [...meanValues, ...p95Values];
      const minY = 0;
      const maxY = Math.max(...allValues) * 1.2 || 100;

      // Draw grid
      ctx.strokeStyle = '#e5e7eb';
      ctx.lineWidth = 1;
      for (let i = 0; i <= 4; i++) {
        const y = padding + (height - 2 * padding) * i / 4;
        ctx.beginPath();
        ctx.moveTo(padding, y);
        ctx.lineTo(width - padding, y);
        ctx.stroke();
      }

      // Draw P95 line
      drawLine(ctx, lagHistory, 'p95', '#f59e0b', minY, maxY, width, height, padding);

      // Draw mean line
      drawLine(ctx, lagHistory, 'mean', '#3b82f6', minY, maxY, width, height, padding);

      // Draw legend
      drawLegend(ctx, [
        { label: 'Mean', color: '#3b82f6' },
        { label: 'P95', color: '#f59e0b' }
      ], width - 100, 10);
    }

    // Draw ELU chart
    function drawEluChart() {
      const canvas = document.getElementById('elu-chart');
      const ctx = canvas.getContext('2d');
      
      canvas.width = canvas.offsetWidth;
      canvas.height = canvas.offsetHeight;

      const width = canvas.width;
      const height = canvas.height;
      const padding = 30;

      ctx.clearRect(0, 0, width, height);

      if (eluHistory.length === 0) return;

      const minY = 0;
      const maxY = 100;

      // Draw grid
      ctx.strokeStyle = '#e5e7eb';
      ctx.lineWidth = 1;
      for (let i = 0; i <= 4; i++) {
        const y = padding + (height - 2 * padding) * i / 4;
        ctx.beginPath();
        ctx.moveTo(padding, y);
        ctx.lineTo(width - padding, y);
        ctx.stroke();
      }

      // Draw utilization line
      drawLine(ctx, eluHistory, 'utilization', '#10b981', minY, maxY, width, height, padding);
    }

    // Helper: Draw line on chart
    function drawLine(ctx, data, key, color, minY, maxY, width, height, padding) {
      ctx.strokeStyle = color;
      ctx.lineWidth = 2;
      ctx.beginPath();

      const xStep = (width - 2 * padding) / (data.length - 1 || 1);
      
      data.forEach((point, i) => {
        const x = padding + i * xStep;
        const value = point[key];
        const y = height - padding - ((value - minY) / (maxY - minY)) * (height - 2 * padding);
        
        if (i === 0) {
          ctx.moveTo(x, y);
        } else {
          ctx.lineTo(x, y);
        }
      });

      ctx.stroke();
    }

    // Helper: Draw legend
    function drawLegend(ctx, items, x, y) {
      ctx.font = '12px sans-serif';
      items.forEach((item, i) => {
        const offsetY = y + i * 20;
        
        // Color box
        ctx.fillStyle = item.color;
        ctx.fillRect(x, offsetY, 12, 12);
        
        // Label
        ctx.fillStyle = '#333';
        ctx.fillText(item.label, x + 18, offsetY + 10);
      });
    }

    // Show error message
    function showError(message) {
      elements.error.textContent = message;
      elements.error.style.display = 'block';
      elements.loading.style.display = 'none';
    }
  </script>
</body>
</html>